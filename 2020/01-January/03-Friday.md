## 计划任务

- [x] 媒资 v1.4.2 接口评审

  当前版本添加 B 站流量回传功能，由于落地页发布时针对 B 站的投放生成的链接会新增标识，也就是说会改变链接，可能产生不可预知的错误。已跟产品、后端说明沟通，又后端做相应处理。

- [x] 确定落地页支付落地方案细节和任务梳理

  用户打开落地页，判定微信浏览器和 URL 上的支付标识。  
  执行微信静默授权 [微信文档](https://developers.weixin.qq.com/doc/offiaccount/OA_Web_Apps/Wechat_webpage_authorization.html)  
  微信静默授权重定向会返回 code，调用媒资后端接口传递 code，后端接收到请求获取 code 后调用微信接口获取 openId，加密之后返回到前端。  
  用户点击落地页支付按钮购买课程，调用媒资后端接口传递加密后的 openId，媒资后端解密获取真实 openId，调用交易组支付服务接口传递 openId。支付服务接收到请求生成订单，调用微信统一下单接口，微信生成预付单并返回。支付服务生成页面调用的支付参数并签名，返回给媒资后端。媒资后端将订单号与 openId 进行绑定，将支付参数透传给前端。  
  前端得到支付参数，调用 [微信支付接口](https://developers.weixin.qq.com/doc/offiaccount/OA_Web_Apps/JS-SDK.html#58)，微信支付服务收到请求，检查参数合法性和授权域权限，返回授权结果，授权成功则唤醒微信支付提示用户输入密码。用户输入完密码确认后会提交支付授权，微信收到请求会验证授权，返回支付结果给到前端。同时，微信会异步通知商户预付单支付结果... [后续流程](https://pay.weixin.qq.com/wiki/doc/api/jsapi.php?chapter=7_4)

- [x] B 站落地页数据回传测试

  测试没问题，已预约 7 号进行线上测试。  
  晚上想到一个问题需要明天确认，基于目前 B 站 的回传机制，无论是否是从 B 站 打开的落地页，只要 URL 带上标识，就都会往页面注入 B 站 js 文件，并在表单提交之后调用 B 站 的数据回传方法，这不合理呀。
